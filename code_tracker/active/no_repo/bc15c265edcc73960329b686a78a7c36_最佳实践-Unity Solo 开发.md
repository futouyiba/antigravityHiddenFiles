/# 最佳实践：Trae Solo 开发 Unity 游戏

## 目标与原则
- 保持代码可测试、可度量、可替换；尽量将“框架/IO”与“纯逻辑”分层。
- 以最小表面积暴露到自动化：输入、UI、时间、随机数、网络均可被替身/脚本驱动。
- 优先复用现有库：本工程已包含 `Photon`、`InControl`、`TextMeshPro`、`YooAssets`、UGUI；新增方案优先兼容现状。

## 项目结构（建议）
- `Assets/Scripts/Core`：跨模块的基础设施（日志、设置、时间、调度、AutomationFacade）。
- `Assets/Scripts/Modules/*`：功能模块（物理、AI、玩家循环、HUD、网络），使用 Assembly Definition 隔离依赖。
- `Assets/Tests/EditMode` / `Assets/Tests/PlayMode`：测试工程；用 `Unity Test Framework` 组织用例。
- `Assets/Resources` / `Assets/YooAssets`：资源组织与包配置；资产命名语义化、分组清晰。
- `Docs`：架构、机制、测试约定与工作流文档（本文件所在目录）。

## 自动化与测试
- 测试分层：
  - EditMode：不依赖场景，验证算法/数据结构/序列化；运行快、定位精准。
  - PlayMode：最小场景夹具加载（湖面+竿位+HUD），驱动玩家循环与鱼线仿真，校验 HUD 指标与状态机。
- 执行（Windows）：
  - `Unity.exe -batchmode -projectPath <项目路径> -runTests -testPlatform EditMode -logfile - -nographics --testResults <out.xml>`
  - `Unity.exe -batchmode -projectPath <项目路径> -runTests -testPlatform PlayMode -logfile - -nographics --testResults <out.xml>`
- 度量采集：用 `UnityEngine.Profiling.ProfilerMarker` 标注关键路径；在 HUD 输出 `HUDMetrics`（帧时间、仿真步数、拉力/线段数等）。
- 自动化门面：建立 `AutomationFacade`（单例/服务定位）暴露控制点：
  - 时间与随机：`ITime`、`IRng` 接口，测试可替身；
  - 输入驱动：`IInputDriver`（见下文）；
  - 屏幕对象模型：按界面定义 `ScreenObjectModel`，通过语义化查询和操作 UI；
  - 记录与断言：将状态快照/指标写入 `XML/CSV`，CI 汇总。

## 输入与驱动（InControl 优先）
- 现工程包含 `InControl`，建议继续使用并封装：
  - 定义 `IInputDriver` 接口：`Read()` 返回标准化输入状态（轴/按钮/指针）。
  - 生产实现：委托到 `InControl` 的设备查询；
  - 测试/自动化实现：脚本化队列驱动（时间戳+动作），支持录制/回放；
  - 玩家循环仅依赖 `IInputDriver`，使 PlayMode 测试可注入脚本化输入。
- 录制/回放：在 `AutomationFacade` 暴露 `StartRecord()`/`Play(sequence)`，结合固定时间步与断言，生成可重复回归用例。

## UI 方案（UGUI + TMP 为主，渐进采用 UI Toolkit）
- 现工程使用 UGUI 与 TextMeshPro：
  - 统一命名：为关键控件赋 `name`/自定义 `AutomationId`；避免层级依赖。
  - 选择器：编写轻量查询器（按 `AutomationId` 查找），构建 `Screen Object Model`。
  - 文本与本地化：继续用 TMP + 既有本地化方案；避免硬编码字符串。
- 新增界面优先使用 UI Toolkit（Runtime）：
  - UXML/USS 结构化、可测试，支持语义化选择器；
  - 与旧 UI 互通，通过门面抽象暴露统一自动化接口。

## 资源与部署（YooAssets）
- 项目已包含 `YooAssets`，建议：
  - 明确包与标签，按场景/系统划分组（基础、鱼类、装备、HUD、音频等）。
  - 约定资产命名与引用规范，避免字符串魔法值；
  - 本地开发使用内置包，后续可扩展远程 Catalog；
  - 在测试中通过资源门面记录加载耗时与失败率，纳入 CI 报告。

## 网络层（Photon）
- 约束：客户端不承载“权威”服务器逻辑；所有网络交互经 `INetwork` 门面：
  - 事件与操作码集中常量化；
  - 本地演示/离线模式用本地事件总线模拟；
  - 房间/玩家状态抽象，避免在 UI/玩法中直接访问 Photon API。
- 测试：提供离线 `FakeNetwork` 实现，驱动典型用例（进房、广播、钓鱼结果同步）。

## 性能与度量
- 标注关键代码：仿真更新、样条构建、HUD 刷新、AI 决策；以 `ProfilerMarker` 埋点。
- 帧预算控制：使用局部更新器（如限时更新器）以热点优先策略；
- 指标面板：`HUDMetrics` 显示仿真步数、线段数、拉力、平均帧时；为自动化断言提供数据源。

## 配置与环境
- 用 `ScriptableObject`/JSON 承载可调参数（仿真阈值、UI 配置、网络地址）；
- 抽象 `ISettingsStore` 替代直接 `PlayerPrefs`；
- 区分 `Dev/CI` 环境开关（日志级别、资源源、网络模拟）。

## CI 与报告
- Windows CI 步骤：
  - 安装/缓存 Unity Editor；
  - BatchMode 运行 EditMode/PlayMode；
  - 收集 `--testResults`（XML），解析生成概览（失败用例、耗时、性能指标）。
- 产出：
  - 测试报告（XML/HTML）、性能快照（CSV）、关键截图/视频（可选）。

## 工作流（Trae 协作）
- 以补丁为单位推进改动；文档与代码并行更新，保持基线可查。
- 在 `Docs` 持续沉淀：架构、机制、测试约定、变更记录、故障与回归用例。
- 引入 MCP（可选）：将工具与资源暴露给协作代理（构建、测试、度量查询）。

## 最小落地清单
- 建立 `AutomationFacade` 与 `IInputDriver`/`ITime`/`IRng` 接口。
- 为 HUD/关键 UI 添加 `AutomationId` 并实现查询器与 `Screen Object Model`。
- 添加 EditMode/PlayMode 基础用例与 BatchMode 执行脚本。
- 在仿真/AI/HUD 标注 `ProfilerMarker` 并汇总到 `HUDMetrics`。
- 整理资源分组（YooAssets）与加载门面，统计耗时与失败率。
- 网络门面与离线模拟实现，消除对 Photon 直接耦合。

---
本文件为 Solo 开发的“可执行最佳实践”清单。后续按条目推进，并将新增的门面、接口、度量点与测试用例纳入版本控制与 CI。
/2sfile:///e:/DocsHDD/fishingplanet2022/Docs/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-Unity%20Solo%20%E5%BC%80%E5%8F%91.md