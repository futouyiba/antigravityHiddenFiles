:# 物理仿真深度解析

## 架构与目标
- 目标：以小步长量化与线程镜像实现钓具/鱼体的稳定、可控仿真，兼顾实时视觉（鱼线样条、杆弯曲）与交互反馈（拉拽、张力、冲量）。
- 架构：
  - 源仿真（`ConnectedBodiesSystem` 派生，如 `FishingRodSimulation`）运行迭代 `Update(dt)` → `Operate` → `Simulate`。
  - 线程仿真镜像（`SimulationThread`）维护镜像结构与动作队列，在独立线程迭代并回写主线程。

## 时间量化与迭代算法
- 常量与帧细分：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:21`（`TimeQuant=0.0004f`）；`Simulation.cs:195-209`（按 `NumOfIterations` 将单帧拆分为多次迭代）。
- 单次迭代流程：`Simulation.cs:187-193`
  - `Reset()` 清零约束与中间量。
  - `Solve()` 求解约束与外力（由各连接与对象实现）。
  - `Simulate(dt)` 积分质量点/刚体状态，更新帧进度。
- 能量：`Simulation.cs:315-333` 动能与弹性势能计算，便于基线测试与调优。

## 数据模型与关键类
- `Mass`（质量点）：位置/速度/旋转、力/电机、碰撞类型（`Full/Partial/None`）、环境参数（浮力/水阻/空气阻力/摩擦）、速度上限与地面高度，支持引用/运动监测；典型用法见 `FishingRodSimulation.cs:2111-2120, 2411-2433`。
- `RigidBody`（刚体）：角速度/扭矩/惯性张量、旋转阻尼、轴向水阻、碰撞接触；示例：`FishingRodSimulation.AttachRigidBody`（`FishingRodSimulation.cs:666-705`）。
- `ConnectionBase` 派生：
  - `Spring`：线性弹簧与冲量约束，支持 `ImpulseThreshold2/ImpulseVerletMax2`、`SetSpringLengthImmediate`；见 `FishingRodSimulation.cs:1060-1073, 2287-2304`。
  - `Bend`：杆骨骼弯曲与回位，用于程序化蜂窝节点对齐；见 `FishingRodSimulation.cs:2655-2663`。
- 对象容器：`SpringDrivenObject/RodObjectInHands/TackleObject/PhyObject`；承载 Mass/Spring 组合以便统一刷新与采样。

## 线程镜像与主线程同步
- 线程主循环：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:415-464`
  - 脉冲-等待 → 平滑 `cachedDeltaTime`（`SimulationThread.cs:431`）→ 迭代源仿真 → 程序化杆弯曲与样条构建。
- 结构同步：`SimulationThread.cs:550-803` 新增/删除质量点/连接/对象的镜像维护。
- 动作队列：`SimulationThread.cs:841-955` 动态修改位置/速度/力/阻尼/类型/碰撞/速度上限等；主线程发起，线程侧应用。
- 主线程同步回写：`SimulationThread.cs:1493-1554` 将线程状态回写至源仿真，更新镜像字典与采样数据。

## 约束求解细节（线与杆）
- 线冲量约束：`FishingRodSimulation.Solve`（`FishingRodSimulation.cs:1656-1726`）在首迭代时尝试约束线端距离不超过膨胀的目标长度，调用 `Spring.SatisfyImpulseConstraintMass` 限制瞬时拉伸并累计平均力（`LineTipMass.UpdateAvgForce`）。
- 线长维护：`UpdateNonUniformLine/UpdateOneSegmentLine/SimulateLineLengthChange`（`FishingRodSimulation.cs:2007-2083, 1992-2005, 2085-2127`）根据目标长度增删段并调整各段长度，确保非均匀分布与张力段记账。
- 杆弯曲：程序化蜂窝节点对齐与 Bezier 曲线构造（`SimulationThread.cs:1033-1094`），并在 `_horizontalRealignLineMasses` 将杆节点回位（`FishingRodSimulation.cs:2648-2687`）。
- 速度与冲量阈值：
  - 线与诱饵：`UpdateTackleVelocityLimit` 设置 `CurrentVelocityLimit` 与 `ImpulseThreshold2`（环境/飞行/中鱼/躺底）；`FishingRodSimulation.cs:2306-2357`。
  - 鱼钩与鱼体：`UpdateTackleSpringMaxImpulse` 将 `ImpulseVerletMax2` 绑定到 `Reel.CurrentFrictionForce`（`FishingRodSimulation.cs:2285-2304`）。

## 碰撞、拖曳与浮力
- 质量点：
  - 空气/水阻常量与速度修正：`BuildLine/BuildNonUniformLine`（`FishingRodSimulation.cs:553-555, 613-615`）在创建段时设置 `WaterDragConstant/AirDragConstant/Buoyancy`。
  - 地面高度：`_horizontalRealignLineMasses` 中按 `GroundHeight` 对位置抬升（`FishingRodSimulation.cs:2673-2682`）。
- 刚体：
  - 旋转/水阻/空气阻力：`AttachRigidBody` 设置 `RotationDamping/UnderwaterRotationDamping/AxialWaterDragEnabled/AirDragConstant`（`FishingRodSimulation.cs:681-689`）。
  - 惯性张量：`RigidBody.SolidBoxInertiaTensor` 应用（`FishingRodSimulation.cs:695-699`）。
- 复合浮力：
  - TopWater/Wobbler 等诱饵对象设置体积浮力、纵/横向水阻、失衡参数（`FishingRodSimulation.cs:776-795, 852-861`）。

## 样条构建（鱼线可视）
- Hermite/Bezier：`Assets/Scripts/Assembly-CSharp/Phy/SplineBuilder.cs:25-74, 76-127` 根据线段长度自适配分段密度。
- Bezier5+CatmullRom：`SplineBuilder.cs:321-359` 与 `SimulationThread.cs:1125-1160` 组合生成高质量曲线，含噪声扰动（`SplineBuilder.cs:361-365`）。
- 帧内点数上限：`SplineBuilder.cs:23`（`MaxBezier5CatmullRomCompositePoints=1000`）与动态调整（`SplineBuilder.cs:281-285`）。

## 杆与线的特化策略
- 非均匀线：首段长度为 `num2*0.05f`，后段按 `0.05f*(1+((i-1-1)+num2)*1.2f)` 增长（`FishingRodSimulation.cs:601-610, 2052-2066`）。
- 线段增删：`AddSegment/RemoveSegment` 在 `RodTipMass` 与首段之间插入/移除质量点与弹簧，维护链表关系（`FishingRodSimulation.cs:2129-2182, 2160-2182`）。
- 自动张力：依据 `RodTipMass` 与 `LineTensionDetectorMass` 的距离迭代调整 `FinalLineLength`（`FishingRodSimulation.cs:1384-1399`）。
- 抛投/挂底重整：`RealignLineAfterThrow/RealignLineAfterHitch` 按目标比例对整条线位置重算（`FishingRodSimulation.cs:2567-2590, 2604-2641`）。

## 稳定性策略与边界
- 步长与速度：线程侧平滑 `cachedDeltaTime` 并限制最大迭代步（`SimulationThread.cs:431, 194-199`）；局部速度上限在对象/连接上以阈值控制冲量。
- 约束守恒：在强拉伸情况下采用冲量满足策略（`Spring.SatisfyImpulseConstraintMass` 调用参考 `FishingRodSimulation.cs:1710-1720`）。
- 视觉与数值一致性：样条点数受 1000 点上限约束，建议按设备分档控制（高段更多点，低段简化）。

## 性能热点与采样建议
- 热点：迭代次数（`Simulation.Update`）、结构/动作同步（`SimulationThread.SyncMain/StructureSync`）、样条构建（`SplineBuilder.Build*`）。
- 采样：在上述函数入口插入 `ProfilerMarker` 与日志标签；记录迭代耗时、同步耗时分布、样条点数；建立基线并作为自动化阈值。

## 测试建议
- EditMode：
  - 样条算法：给定点集/噪声/alpha，断言连续性、端点、上限。
  - 约束与线长：构造简化线，验证增删段后总长度与张力段计数正确。
  - 能量近似：在禁碰撞场景下验证动能/势能随迭代收敛性。
- PlayMode：
  - 抛投→落水→收线：断言 `CurrentLineLength` 与 `RodAppliedForce` 的预期路径；
  - 线程健壮性：波动 `deltaTime` 下统计 `SyncMain` 成功率与超时；
  - 视觉一致：样条点数与 HUD 指示（线长/目标）一致。

## 改造方向（概览）
- 并发：迁移热点至 Job System + Burst，使用 `Unity.Mathematics` 替换 `Mono.Simd`。
- 约束：统一冲量阈值与速度上限策略，设备分档控制；
- 可配置化：线/杆参数转 `ScriptableObject`，利于数值调优与自动化测试覆盖。:2file:///e:/DocsHDD/fishingplanet2022/Docs/%E6%9C%BA%E5%88%B6-%E7%89%A9%E7%90%86%E4%BB%BF%E7%9C%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.md