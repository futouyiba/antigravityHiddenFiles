# 物理仿真详解

## 设计目标与架构
- 目标：以小步长的离散迭代实现钓具与鱼体的稳定仿真，兼顾性能与可视表现（鱼线样条、杆弯曲）。
- 架构：源仿真 `ConnectedBodiesSystem` + 线程仿真镜像，主线程负责消费与回写；线程侧负责迭代与构建样条。

## 时间量化与迭代
- 时间常量：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:21`（`TimeQuant=0.0004f`）。
- 帧细分迭代：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:195-209`
  - 按 `NumOfIterations=(int)(dt/TimeQuant)+1` 将单帧拆分为多次 `Operate(dt/Num)`。
  - 每次迭代流程：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:187-193`
    - `Reset()` 清零约束与中间量。
    - `Solve()` 计算约束与外力（抽象，由具体仿真实现）。
    - `Simulate(dt)` 积分质量点状态并累加计数。

## 数据结构与约束
- 质量点与连接：
  - `Mass`（含位置/速度/类型/碰撞/拖曳），连接抽象 `ConnectionBase`（弹簧/弯曲/磁力/传动等）。
  - 刚体与水阻/浮力：`Assets/Scripts/Assembly-CSharp/Phy/RigidBody.cs`（包含水阻轴向系数、碰撞平面同步）。
- 数组刷新：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:211-239`
  - 剔除禁用仿真实例，填充 `paddingMasses` 以满足 SIMD 对齐。

## 线程镜像与动作队列
- 线程主循环：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:415-464`
  - 等待主线程脉冲 → 设置 `cachedDeltaTime`（平滑限制，`SimulationThread.cs:431`） → 迭代 `sim.Update` → 程序化杆弯曲与样条构建。
- 主线程同步：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:1493-1554`
  - 刷新源结构 → 将线程仿真回写至源（Mass/Object 字典） → 可选执行 `SyncSim()` 的结构/动作同步。
- 结构同步：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:550-803`
  - 新增/删除质量点、连接、对象的镜像创建/移除与 `Dict*` 更新。
- 动作队列应用：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:841-955`
  - 支持位置/速度/力/电机/阻尼/质量类型/碰撞类型/禁用仿真/全局速度上限等动态修改。

## 鱼线样条构建（Bezier5 + CatmullRom）
- 接口：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:1125-1160`
  - 从线的质量点序列采样生成控制点列表 → 组合 Bezier5 与 CatmullRom → 输出样条点缓存。
- 用途：渲染与采样（HUD、碰撞估计），点数与平滑度影响性能与视觉质量。

## 能量与稳定策略
- 系统能量计算：`Assets/Scripts/Assembly-CSharp/Phy/Simulation.cs:315-333`
  - 动能：质量点速度与质量累加；势能：连接弹性势能累加。
- 步长与速度上限：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:431`
  - 将 `DeltaTime` 平滑至允许范围以避免积分发散；全局/局部速度上限通过队列动作设置。

## 杆弯曲与程序化外观
- Rod 程序化弯曲：`Assets/Scripts/Assembly-CSharp/Phy/SimulationThread.cs:1033-1094`
  - 采集杆质量点位置，构造 Bezier 曲线并对 Locator 环进行弯曲变换，生成首环与各 Locator 的位置。

## 性能与热点建议
- 热点：迭代次数、线程同步、样条构建。
- 建议：
  - 在上述位置插入 `ProfilerMarker` 采集耗时与点数；
  - 对样条点数建立上限与分档；
  - 对 `NumOfIterations` 动态限制（按设备档位）。

## 未来改造建议（概览）
- 并发：将迭代热点迁移至 Job System + Burst，替换 `Mono.Simd` 为 `Unity.Mathematics`。
- 队列：封装线程安全动作队列接口，明确时序与冲突规避策略。2vfile:///e:/DocsHDD/fishingplanet2022/Docs/%E6%9C%BA%E5%88%B6-%E7%89%A9%E7%90%86%E4%BB%BF%E7%9C%9F%E8%AF%A6%E8%A7%A3.md